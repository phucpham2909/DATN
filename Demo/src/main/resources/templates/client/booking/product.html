<!DOCTYPE html>
<html th:replace="~{/shared/layout::view(~{::title}, ~{::article})}">
<head>
<meta charset="UTF-8">
<title>Bắp Nước & Combo</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">

<style>

.combo-card{
    border-radius:10px;
    overflow:hidden;
}

.qty-box{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
}

.qty-btn{
    width:36px;
    height:36px;
    border:none;
    border-radius:50%;
    background:#dc3545;
    color:white;
    font-size:18px;
    font-weight:bold;
}

.qty-btn:hover{
    background:#bb2d3b;
}

.qty-val{
    min-width:36px;
    text-align:center;
    font-size:18px;
    font-weight:600;
}

#summary{
    font-size:20px;
    font-weight:bold;
}
</style>
</head>

<body>
<article class="container my-5 p-5">

<div class="text-center mb-4">
    <h1 class="fw-bold text-danger">MUA BẮP NƯỚC & COMBO</h1>
</div>

<input type="hidden" id="bookingId" th:value="${booking.id}">
<input type="hidden" id="suatChieuId" th:value="${booking.suatChieu.id}">

<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">

<div class="col" th:each="p : ${products}">
<div class="card h-100 shadow-sm combo-card">

    <img th:src="@{'/images/' + ${p.images}}"
         class="card-img-top"
         style="height:220px;object-fit:cover">

    <div class="card-body d-flex flex-column">

        <h5 th:text="${p.name}"></h5>
        <p th:text="${p.description}"></p>

        <p class="fw-bold text-danger"
           th:data-price="${p.price}"
           th:text="${#numbers.formatDecimal(p.price,0,'POINT',0,'COMMA')} + ' VND'">
        </p>

        <div class="qty-box mt-auto">

            <button type="button" class="qty-btn minus">−</button>

            <div class="qty-val">0</div>

            <button type="button" class="qty-btn plus">+</button>
        </div>

        <input type="hidden"
               class="productId"
               th:value="${p.id}">

        <input type="hidden"
               class="qtyInput"
               value="0">

    </div>

</div>
</div>

</div>

<hr>

<!-- SUMMARY BLOCK DƯỚI -->
<div class="card shadow-sm border-0 mt-4">
    <div class="row g-0 align-items-center">

        <!-- BÊN TRÁI (có thể để trống hoặc ghi chú) -->
        <div class="col-md-8">
            <div class="card-body text-start">
                <h5 class="mb-1">Bắp nước & Combo</h5>
                <p class="mb-0 text-muted">
                    Bạn có thể mua thêm combo hoặc bỏ qua bước này
                </p>
            </div>
        </div>

        <!-- BÊN PHẢI (SUMMARY + NÚT) -->
        <div class="col-md-4 text-center">
            <div id="summary" class="fw-bold fs-5 mb-3">
                Đã chọn 0 combo — Tổng combo: 0₫
            </div>

            <a th:href="@{/booking/choose-seat(suatChieuId=${booking.suatChieu.id})}"
               class="btn btn-secondary mt-3">
                ⬅ Trở về chọn ghế
            </a>

            <button id="confirmComboBtn"
                    class="btn btn-success ms-3 mt-3">
                Xác nhận
            </button>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const cards = document.querySelectorAll(".combo-card");
    const summary = document.getElementById("summary");

    function formatVND(v){
    	return v.toLocaleString('vi-VN') + ' VND';
    }

    function updateSummary(){
        let totalQty = 0;
        let totalPrice = 0;

        cards.forEach(card => {
            const price = parseInt(card.querySelector("[data-price]").dataset.price);
            const qty = parseInt(card.querySelector(".qty-val").textContent);
            totalQty += qty;
            totalPrice += qty * price;
        });

        summary.innerHTML =
            `Đã chọn ${totalQty} combo — Tổng combo: ${formatVND(totalPrice)}`;
    }

    // Xử lý nút + -
    cards.forEach(card => {

        const plus = card.querySelector(".plus");
        const minus = card.querySelector(".minus");
        const qtyVal = card.querySelector(".qty-val");
        const qtyInput = card.querySelector(".qtyInput");

        plus.addEventListener("click", () => {
            qtyVal.textContent = parseInt(qtyVal.textContent) + 1;
            qtyInput.value = qtyVal.textContent;
            updateSummary();
        });

        minus.addEventListener("click", () => {
            let q = parseInt(qtyVal.textContent);
            if (q <= 0) return;
            qtyVal.textContent = q - 1;
            qtyInput.value = qtyVal.textContent;
            updateSummary();
        });

    });

    // Xử lý confirm
    document.getElementById("confirmComboBtn").addEventListener("click", function (e) {

        e.preventDefault();

        const bookingId = document.getElementById("bookingId").value;
        const combos = [];

        cards.forEach(card => {
            const qty = parseInt(card.querySelector(".qtyInput").value);
            if (qty > 0) {
                combos.push({
                    productId: card.querySelector(".productId").value,
                    quantity: qty
                });
            }
        });

        if (combos.length === 0) {
            window.location.href = "/booking/confirm?bookingId=" + bookingId;
            return;
        }

        let pending = combos.length;

        combos.forEach(c => {
            fetch("/booking/add-combo", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `bookingId=${bookingId}&productId=${c.productId}&quantity=${c.quantity}`
            }).then(() => {
                pending--;
                if (pending === 0) {
                    window.location.href = "/booking/confirm?bookingId=" + bookingId;
                }
            });
        });

    });

});
</script>

</article>
</body>
</html>
