<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout2 :: layout(~{::head}, ~{::body})}">

<head>
  <meta charset="UTF-8">
  <title>X√°c nh·∫≠n ƒë·∫∑t v√©</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
    }

    .section-box {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 25px;
    }

    .movie-img {
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      max-height: 350px;
      object-fit: cover;
    }

    .info-label {
      font-weight: 600;
      color: #555;
    }

    .price-box {
      background-color: #fff7e6;
      border: 1px solid #ffe0b2;
      border-radius: 8px;
      padding: 10px 15px;
    }

    .btn-confirm {
      background-color: #28a745;
      border: none;
    }

    .btn-confirm:hover {
      background-color: #218838;
    }
  </style>
</head>

<body>
  <article>
    <div class="container my-5" id="checkout-container">
      <h3 class="fw-bold text-center mb-4 text-danger">üé´ X√°c nh·∫≠n ƒë·∫∑t v√©</h3>
      <div id="checkout-content"></div>
    </div>

    <script>
      async function loadCheckout() {
        const params = new URLSearchParams(window.location.search);
        const movieId = params.get("movieId");
        const seats = params.get("seats");

        const container = document.getElementById("checkout-content");

        if (!movieId || !seats) {
          container.innerHTML = `
            <div class="alert alert-danger text-center fw-semibold">
              ‚ö†Ô∏è Thi·∫øu th√¥ng tin ƒë·∫∑t v√©! Vui l√≤ng quay l·∫°i ch·ªçn phim v√† gh·∫ø.
            </div>`;
          return;
        }

        try {
          const res = await fetch(`/api/booking/checkout?movieId=${movieId}&seats=${seats}`);
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin v√©.");
          const data = await res.json();

          const movie = data.movie;
          const seatList = data.seats.join(", ");

          container.innerHTML = `
            <div class="section-box">
              <div class="row align-items-start g-4">
                <div class="col-md-4 text-center">
                  <img src="${movie.image}" alt="${movie.title}" class="img-fluid movie-img mb-3">
                  <span class="badge bg-warning text-dark">‚≠ê ${movie.rating}</span>
                </div>

                <div class="col-md-8">
                  <h4 class="fw-bold mb-3 text-dark">${movie.title}</h4>
                  <p><span class="info-label">üé¨ Th·ªÉ lo·∫°i:</span> ${movie.genre}</p>
                  <p><span class="info-label">üè¢ R·∫°p:</span> ${data.cinema}</p>
                  <p><span class="info-label">üïí Su·∫•t chi·∫øu:</span> ${data.showtime}</p>
                  <p><span class="info-label">üí∫ Gh·∫ø ƒë√£ ch·ªçn:</span> ${seatList}</p>
                  
                  <div class="price-box mt-3 mb-3">
                    <p class="mb-1"><strong>Gi√° v√©:</strong> ${data.pricePerSeat}K / gh·∫ø</p>
                    <h5 class="text-danger fw-bold mb-0">T·ªïng c·ªông: ${data.total}K</h5>
                  </div>

                  <button class="btn btn-confirm text-white px-4 py-2 mt-2"
                    onclick="confirmBooking(${movie.id}, '${seatList}')">
                    ‚úÖ X√°c nh·∫≠n & Thanh to√°n
                  </button>
                </div>
              </div>
            </div>
          `;
        } catch (error) {
          container.innerHTML = `
            <div class="alert alert-danger text-center">
              ‚ùå ${error.message}
            </div>`;
        }
      }

      async function confirmBooking(movieId, seatList) {
        const info = {
          movie: { id: movieId },
          seats: seatList.split(", ")
        };

        try {
          const res = await fetch("/api/booking/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(info)
          });
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë·∫∑t v√©.");

          window.location.href = `/booking/success?movieId=${movieId}&seats=${seatList}`;
        } catch (error) {
          alert("‚ùå " + error.message);
        }
      }

      loadCheckout();
    </script>
  </article>
</body>
</html>
