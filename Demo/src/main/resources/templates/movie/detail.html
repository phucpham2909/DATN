<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout2 :: layout(~{::head}, ~{::body})}">
<head>
  <meta charset="UTF-8">
  <title>Chi ti·∫øt phim</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .movie-card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08); }
    .movie-img { border-radius: 8px; width: 100%; height: auto; object-fit: cover; }
    .section-title { font-weight: 600; margin-top: 30px; margin-bottom: 15px; }
    .comment-box { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1); }
    .btn-time { border: 1px solid #ffc107; color: #000; background-color: #fff; border-radius: 6px; padding: 5px 10px; margin: 2px; transition: 0.2s; }
    .btn-time:hover { background-color: #ffc107; color: #000; }
    iframe { border-radius: 8px; }
  </style>
</head>

<body>
  <article>
    <div class="container my-5">
      <div id="movie-detail">
        <div class="text-center text-muted py-5">ƒêang t·∫£i th√¥ng tin phim...</div>
      </div>
    </div>

    <script>
      async function loadMovieDetail() {
        try {
          const id = window.location.pathname.split("/").pop();
          const res = await fetch(`/api/movies/${id}`);
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu phim.");
          const data = await res.json();
          const movie = data.movie;
          const showtimes = data.showtimes;
          const comments = data.comments;

          document.getElementById("movie-detail").innerHTML = `
            <div class="movie-card mb-4">
              <div class="row g-4 align-items-start">
                <div class="col-md-4 text-center">
                  <img src="${movie.image}" alt="${movie.title}" class="movie-img mb-3">
                  <div><span class="badge bg-warning text-dark">‚≠ê ${movie.rating}</span></div>
                </div>
                <div class="col-md-8">
                  <h3 class="fw-bold">${movie.title}</h3>
                  <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genre}</p>
                  <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${movie.duration}</p>
                  <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.releaseDate}</p>
                  <p class="text-muted">${movie.description}</p>
                  <a href="/booking?movieId=${movie.id}" class="btn btn-danger mt-2">üéü ƒê·∫∑t v√© ngay</a>
                </div>
              </div>
            </div>

            <h5 class="section-title">üé• Trailer</h5>
            <div class="ratio ratio-16x9 mb-4">
              <iframe src="${movie.trailer}" allowfullscreen></iframe>
            </div>

            <h5 class="section-title">üïí Su·∫•t chi·∫øu</h5>
            ${
              showtimes.length === 0
                ? `<p class="text-muted fst-italic">Ch∆∞a c√≥ su·∫•t chi·∫øu n√†o.</p>`
                : showtimes.map(s => `
                    <div class="mb-3">
                      <strong>${s.cinema}</strong><br>
                      ${s.times.map(t => `<button class="btn-time">${t}</button>`).join("")}
                    </div>
                  `).join("")
            }

            <div class="comment-box mt-5">
              <h5 class="section-title">üí¨ B√¨nh lu·∫≠n (${comments.length})</h5>
              <div id="comment-list">
                ${comments.map(c => `
                    <div class="border rounded p-2 mb-2">
                      <strong>${c.username}</strong>
                      <small class="text-muted">(${c.time})</small><br>
                      <p class="mb-0">${c.content}</p>
                    </div>
                `).join("")}
              </div>
              <div class="mt-3">
                <textarea id="new-comment" class="form-control mb-2" placeholder="Th√™m b√¨nh lu·∫≠n..."></textarea>
                <button class="btn btn-primary btn-sm" onclick="addComment()">G·ª≠i</button>
              </div>
            </div>
          `;
        } catch (err) {
          document.getElementById("movie-detail").innerHTML =
            `<div class="alert alert-danger text-center">${err.message}</div>`;
        }
      }

      function addComment() {
        const text = document.getElementById("new-comment").value.trim();
        if (!text) return;
        const list = document.getElementById("comment-list");
        const newCmt = `
          <div class="border rounded p-2 mb-2">
            <strong>B·∫°n</strong> <small class="text-muted">(v·ª´a xong)</small><br>
            <p class="mb-0">${text}</p>
          </div>`;
        list.insertAdjacentHTML("afterbegin", newCmt);
        document.getElementById("new-comment").value = "";
      }

      loadMovieDetail();
    </script>
  </article>
</body>
</html>
